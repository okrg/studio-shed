window.GFStripe=null,function(m){GFStripe=function(e){for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r]);this.form=null,this.init=function(){if(this.isCreditCardOnPage()||"checkout"===this.stripe_payment){var d=this,_=null,o=!1,i=!1,s=d.apiKey;switch(gform.addAction("gform_frontend_feeds_evaluated",function(e,r){_=null,i=o=!1;for(var t=0;t<Object.keys(e).length;t++)if("gravityformsstripe"===e[t].addonSlug&&e[t].isActivated){switch(o=!0,_=d.feeds[t],s=_.hasOwnProperty("apiKey")?_.apiKey:d.apiKey,d.stripe_payment){case"elements":g=Stripe(s),a=g.elements(),i=""!==_.address_zip,0<=a._elements.indexOf("card")&&l.destroy(),m(p).next(".validation_message").length&&m(p).next(".validation_message").html(""),(l=a.create("card",{classes:d.cardClasses,style:d.cardStyle,hidePostalCode:i})).mount(p),l.on("change",function(e){d.displayStripeCardError(e)});break;case"stripe.js":Stripe.setPublishableKey(s)}break}if(!o){if("elements"===d.stripe_payment)null!==a&&0<=a._elements.indexOf("card")&&l.destroy(),m(p).next(".validation_message").length||m(p).after('<div class="gfield_description validation_message"></div>'),m(p).next(".validation_message").html(gforms_stripe_frontend_strings.no_active_frontend_feed);d.form=m("#gform_"+r),d.resetStripeStatus(d.form,r,d.isLastPage()),s=d.apiKey}}),d.stripe_payment){case"elements":var g=null,a=null,p="#input_"+d.formId+"_"+d.ccFieldId+"_1",l=null,f=!1}m("#gform_"+this.formId).submit(function(e){if(o&&!(m(this).data("gfstripesubmitting")||1==m("#gform_save_"+d.formId).val()||!d.isLastPage()&&"elements"!==d.stripe_payment||gformIsHidden(m(p))))switch(e.preventDefault(),m(this).data("gfstripesubmitting",!0),d.maybeAddSpinner(),d.stripe_payment){case"elements":d.form=m(this);var r=parseInt(m("#gform_source_page_number_"+d.formId).val(),10),t=parseInt(m("#gform_target_page_number_"+d.formId).val(),10);if(t<r&&0!==t&&(f=!0),d.isLastPage()&&!d.isCreditCardOnPage()||gformIsHidden(m(p))||f)return void m(this).submit();var i={name:m("#input_"+d.formId+"_"+d.ccFieldId+"_5").val(),address_line1:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_line1)),address_line2:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_line2)),address_city:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_city)),address_state:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_state)),address_zip:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_zip)),address_country:GFMergeTag.replaceMergeTags(d.formId,d.getBillingAddressMergeTag(_.address_country)),currency:gform.applyFilters("gform_stripe_currency",d.currency,d.formId)};g.createToken(l,i).then(function(e){d.elementsResponseHandler(e)});break;case"checkout":m(this).submit();break;case"stripe.js":var s=m(this),a="input_"+d.formId+"_"+d.ccFieldId+"_",n={number:s.find("#"+a+"1").val(),exp_month:s.find("#"+a+"2_month").val(),exp_year:s.find("#"+a+"2_year").val(),cvc:s.find("#"+a+"3").val(),name:s.find("#"+a+"5").val()};d.form=s,Stripe.card.createToken(n,function(e,r){d.responseHandler(e,r)})}})}},this.getBillingAddressMergeTag=function(e){return""===e?"":"{:"+e+"}"},this.responseHandler=function(e,r){for(var t=this.form,i="input_"+this.formId+"_"+this.ccFieldId+"_",s=["1","2_month","2_year","3","5"],a=0;a<s.length;a++){var n=t.find("#"+i+s[a]);if("1"==s[a]){var d=m.trim(n.val()),_=gformFindCardType(d);void 0!==this.cardLabels[_]&&(_=this.cardLabels[_]),t.append(m('<input type="hidden" name="stripe_credit_card_last_four" />').val(d.slice(-4))),t.append(m('<input type="hidden" name="stripe_credit_card_type" />').val(_))}}t.append(m('<input type="hidden" name="stripe_response" />').val(m.toJSON(r))),t.submit()},this.elementsResponseHandler=function(e){var r=this.form;m("#gf_stripe_response").length?m("#gf_stripe_response").val(m.toJSON(e)):r.append(m('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(m.toJSON(e))),e.error?(this.displayStripeCardError(e),this.resetStripeStatus(r,this.formId,this.isLastPage())):(r.append(m('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.token.card.last4)),r.append(m('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.token.card.brand)),r.submit())},this.isLastPage=function(){var e=m("#gform_target_page_number_"+this.formId);return!(0<e.length)||0==e.val()},this.isCreditCardOnPage=function(){var e=this.getCurrentPageNumber();return!this.ccPage||!e||this.ccPage==e},this.getCurrentPageNumber=function(){var e=m("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.maybeAddSpinner=function(){if(!this.isAjax)if("function"==typeof gformAddSpinner)gformAddSpinner(this.formId);else{var e=this.formId;if(0==jQuery("#gform_ajax_spinner_"+e).length){var r=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,e);gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+e+", #gform_wrapper_"+e+" .gform_next_button, #gform_send_resume_link_button_"+e),e).after('<img id="gform_ajax_spinner_'+e+'"  class="gform_ajax_spinner" src="'+r+'" alt="" />')}}},this.resetStripeStatus=function(e,r,t){m("#gf_stripe_response, #gf_stripe_credit_card_last_four, #stripe_credit_card_type").remove(),e.data("gfstripesubmitting",!1),m("#gform_ajax_spinner_"+r).remove(),t&&(window["gf_submitting_"+r]=!1)},this.displayStripeCardError=function(e){var r="#input_"+this.formId+"_"+this.ccFieldId+"_1";m(r).next(".validation_message").length||m(r).after('<div class="gfield_description validation_message"></div>');var t=m(r).next(".validation_message");e.error?(t.html(e.error.message),0<m("#gform_ajax_spinner_"+this.formId).length&&m("#gform_ajax_spinner_"+this.formId).remove()):t.html("")},this.init()}}(jQuery);